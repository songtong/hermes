<?xml version="1.0" encoding="UTF-8"?>
<entities do-package="com.ctrip.hermes.admin.core.queue" gen="true">
	<entity name="message-priority" implements="com.ctrip.hermes.admin.core.queue.ds.TopicPartitionPriorityAware">
		<var name="topic" value-type="String" />
		<var name="partition" value-type="int" />
		<var name="priority" value-type="int" />
		<var name="start-id" value-type="long" />
		<var name="batch-size" value-type="int" />
		<var name="find-count" value-type="int" />

		<readsets>
			<readset name="ID">
				<member name="id" />
			</readset>
			<readset name="CREATE_DATE">
				<member name="id" />
				<member name="creation-date"></member>
			</readset>
		</readsets>

		<query-defs>
			<query name="insert" type="INSERT" batch='true'>
				<statement><![CDATA[INSERT INTO <TABLE/>(<FIELDS/>)
        		VALUES(<VALUES/>)]]>
				</statement>
			</query>
			<query name="findIdAfter" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="start-id" />
				<param name="batch-size" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='id'/> > ${start-id}
        		LIMIT ${batch-size}]]>
				</statement>
			</query>
			<query name="topK" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="find-count" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		ORDER BY <FIELD name='id'/> DESC
        		LIMIT ${find-count}
        		]]>
				</statement>
			</query>
			<query name="find-by-PK" type="SELECT">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="key-id" />
				<statement><![CDATA[SELECT <FIELDS/>
		        FROM <TABLE/>
		        WHERE <FIELD name='id'/> = ${key-id}]]></statement>
			</query>
			<query name="latest" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		ORDER BY <FIELD name='id'/> DESC
        		LIMIT 1
        		]]>
				</statement>
			</query>
			<query name="oldest" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		ORDER BY <FIELD name='id'/> ASC
        		LIMIT 1
        		]]>
				</statement>
			</query>
		</query-defs>
		<snippet lang='java'><![CDATA[
			public static java.util.Comparator<MessagePriority> DATE_COMPARATOR_DESC = new java.util.Comparator<MessagePriority>() {
				@Override
				public int compare(MessagePriority o1, MessagePriority o2) {
					return o1.getCreationDate().compareTo(o2.getCreationDate());
				}
			};
		]]></snippet>
	</entity>

	<entity name="offset-message" implements="com.ctrip.hermes.admin.core.queue.ds.TopicPartitionPriorityAware">
		<var name="partition" value-type="int" />
		<var name="topic" value-type="String" />
		<updatesets>
			<updateset name="OFFSET">
				<member name='offset' />
			</updateset>
		</updatesets>
		<query-defs>
			<query name="find" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="group-id" />

				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='priority'/> = ${priority}
        		AND <FIELD name='group-id'/> = ${group-id}]]>
				</statement>
			</query>
			<query name="find-all" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />

				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>]]>
				</statement>
			</query>
		</query-defs>
	</entity>

	<entity name="resend-group-id" implements="com.ctrip.hermes.admin.core.queue.ds.TopicPartitionPriorityGroupAware">
		<relation name="message-priority" entity-name="message-priority" entity-alias="mp" />

		<var name="topic" value-type="String" />
		<var name="partition" value-type="int" />
		<var name="group-id" value-type="int" />
		<var name="batch-size" value-type="int" />
		<var name="message-ids" value-type="Long[]" />
		<var name="current-time" value-type="Date" />

		<readsets>
			<readset name="CREATE_DATE">
				<member name="id"></member>
				<member name="creation-date"></member>
			</readset>
		</readsets>

		<query-defs>
			<query name="insert" type="INSERT" batch='true'>
				<statement><![CDATA[INSERT INTO <TABLE/>(<FIELDS/>)
        		VALUES(<VALUES/>)]]>
				</statement>
			</query>
			<query name="find" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<param name="schedule-date" />
				<param name="batch-size" />
				<param name="id" />
				<param name="current-time" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='schedule-date'/> < ${current-time}
        		AND (<FIELD name='schedule-date'/> > ${schedule-date}
        			OR (<FIELD name='schedule-date'/> = ${schedule-date}
        				AND <FIELD name='id'/> > ${id}
        			)
        		)
        		ORDER BY <FIELD name='schedule-date'/>,<FIELD name='id'/> ASC
        		LIMIT ${batch-size}]]>
				</statement>
			</query>
			<query name="copyFromMessageTable" type="INSERT">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="group-id" />
				<param name="schedule-date" />
				<param name="message-ids" />
				<param name="remaining-retries" />
				<statement><![CDATA[INSERT INTO <TABLE/> 
					  (producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,schedule_date,remaining_retries,priority,origin_id) 
        		SELECT producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,${schedule-date},${remaining-retries},${priority},id
        		FROM <TABLE name="message-priority"/>
        		WHERE id IN <IN>${message-ids}</IN>]]>
				</statement>
			</query>
			<query name="copyFromResendTable" type="INSERT" batch="true">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="group-id" />
				<param name="schedule-date" />
				<param name="id" />
				<statement><![CDATA[INSERT INTO <TABLE/> 
				(producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,schedule_date,remaining_retries,priority,origin_id) 
        		SELECT producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,${schedule-date},remaining_retries-1,priority,origin_id
        		FROM <TABLE name="resend-group-id"/>
        		WHERE id = ${id}]]>
				</statement>
			</query>
			<query name="find-by-PK" type="SELECT">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<param name="key-id" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='id'/> = ${key-id}]]></statement>
			</query>
			<query name="latest" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		ORDER BY <FIELD name='id'/> DESC
        		LIMIT 1
        		]]>
				</statement>
			</query>
			<query name="oldest" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		ORDER BY <FIELD name='id'/> ASC
        		LIMIT 1
        		]]>
				</statement>
			</query>

		</query-defs>
	</entity>

	<entity name="offset-resend" alias="ore" implements="com.ctrip.hermes.admin.core.queue.ds.TopicPartitionAware">
		<var name="topic" value-type="String" />
		<var name="partition" value-type="int" />

		<updatesets>
			<updateset name="OFFSET">
				<member name='last-schedule-date' />
				<member name='last-id' />
			</updateset>
		</updatesets>

		<query-defs>
			<query name="top" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='group-id'/> = ${group-id}
        		]]>
				</statement>
			</query>
			<query name="find-all" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>]]>
				</statement>
			</query>
		</query-defs>

	</entity>

	<entity name="dead-letter" implements="com.ctrip.hermes.admin.core.queue.ds.TopicPartitionPriorityGroupAware">
		<relation name="message-priority" entity-name="message-priority" entity-alias="mp" />
		<relation name="resend-group-id" entity-name="resend-group-id" entity-alias="rgi" />
		<var name="topic" value-type="String" />
		<var name="partition" value-type="int" />
		<var name="message-ids" value-type="Long[]" />
		<var name="start-time" value-type="Date" />
		<var name="end-time" value-type="Date" />
		<var name="batch-size" value-type="int" />
		<member name="count-of-time-range" value-type="int" select-expr="COUNT(*)" all="false" />

		<readsets>
			<readset name="COUNT">
				<member name="count-of-time-range" />
			</readset>
			<readset name="CREATE_DATE">
				<member name="id" />
				<member name="creation-date"></member>
			</readset>
		</readsets>

		<query-defs>
			<query name="find-by-time-range" type="SELECT" multiple="false">
				<param name="topic" />
				<param name="partition" />
				<param name="start-time" />
				<param name="end-time" />
				<statement><![CDATA[
				SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='dead-date'/> >= ${start-time}
        		AND <FIELD name='dead-date'/> <= ${end-time}
        		]]>
				</statement>
			</query>
			<query name="find-latest-by-tpg-and-count" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<param name="batch-size" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='group-id'/> = ${group-id}
        		ORDER BY <FIELD name='id'/> DESC
        		LIMIT ${batch-size}
        		]]>
				</statement>
			</query>
			<query name="find-latest-by-endtime-and-tpg" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<param name="end-time" />
				<param name="batch-size" />
				<statement><![CDATA[
				SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='group-id'/> = ${group-id}
        		AND <FIELD name='dead-date'/> <= ${end-time}
        		ORDER BY <FIELD name='id'/> DESC 
        		LIMIT ${batch-size}
        		]]>
				</statement>
			</query>
			<query name="find-latest-by-endid-and-starttime-and-tpg" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<param name="id"/>
				<param name="start-time" />
				<param name="batch-size" />
				<statement><![CDATA[
				SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='group-id'/> = ${group-id}
        		AND <FIELD name='id'/> <= ${id}
        		AND <FIELD name='dead-date'/> >= ${start-time}
        		ORDER BY <FIELD name='id'/> DESC 
        		LIMIT ${batch-size}
        		]]>
				</statement>
			</query>
			<query name="copyFromMessageTable" type="INSERT">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="group-id" />
				<param name="dead-date" />
				<param name="message-ids" />
				<statement><![CDATA[INSERT INTO <TABLE/> 
					(producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,dead_date,group_id,priority,origin_id) 
        		SELECT producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,${dead-date},${group-id},${priority},id
        		FROM <TABLE name="message-priority"/>
        		WHERE id IN <IN>${message-ids}</IN>]]>
				</statement>
			</query>
			<query name="copyFromResendTable" type="INSERT">
				<param name="topic" />
				<param name="partition" />
				<param name="priority" />
				<param name="group-id" />
				<param name="dead-date" />
				<param name="message-ids" />
				<statement><![CDATA[INSERT INTO <TABLE/> 
					(producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,dead_date,group_id,priority,origin_id) 
        		SELECT producer_ip,producer_id,ref_key,attributes,codec_type,creation_date,payload,${dead-date},${group-id},${priority},origin_id
        		FROM <TABLE name="resend-group-id"/>
        		WHERE id IN <IN>${message-ids}</IN>]]>
				</statement>
			</query>
			<query name="find-by-PK" type="SELECT">
				<param name="topic" />
				<param name="partition" />
				<param name="key-id" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='id'/> = ${key-id}]]></statement>
			</query>
			<query name="latest" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		ORDER BY <FIELD name='id'/> DESC
        		LIMIT 1
        		]]>
				</statement>
			</query>
			<query name="oldest" type="SELECT" multiple="true">
				<param name="topic" />
				<param name="partition" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		ORDER BY <FIELD name='id'/> ASC
        		LIMIT 1
        		]]>
				</statement>
			</query>
			<query name="count-by-consumer-time-range" type="SELECT">
				<param name="topic" />
				<param name="partition" />
				<param name="group-id" />
				<param name="start-time" />
				<param name="end-time" />
				<statement><![CDATA[SELECT <FIELDS/>
        		FROM <TABLE/>
        		WHERE <FIELD name='group-id'/> = ${group-id} AND <FIELD name='dead-date'/> BETWEEN ${start-time} AND ${end-time}
        		]]>
				</statement>
			</query>
		</query-defs>
	</entity>


</entities>

